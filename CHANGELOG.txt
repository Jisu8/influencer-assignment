# FNF Crew 앱 변경사항 관리 문서
# 생성일: 2024-12-19
# 관리자: AI Assistant

## 📋 변경사항 관리 시스템

### 문서화 방식:
1. 변경 전후 상태 기록
2. 변경 이유 및 목적 명시  
3. 영향받는 기능들 목록
4. 검증 방법 제시
5. 변경 완료 후 실제 결과 확인

---

## 🔄 변경 이력

### 2024-12-19 2차기간 컬럼 중복 오류 최종 해결

**변경 내용:**
- `prepare_influencer_summary` 함수에서 `2차기간` 컬럼 중복 문제 최종 해결
- `cols.remove("2차기간")` 추가하여 기존 `2차기간` 컬럼을 제거한 후 올바른 위치에 재삽입
- 컬럼 순서를 `2차활용` → `2차기간` → `전체_계약수` → `전체_집행수` → `전체_잔여수` 순서로 유지

**변경 이유:**
- Streamlit 에러 재발생: "All column names are required to be unique for usage with data editor. The following column names are duplicated: ['2차기간']"
- `rename`에서 `2차기간` 컬럼을 추가하고 `cols.insert`에서 다시 추가하여 중복 발생

**영향받는 기능:**
- 인플루언서별 탭의 2차기간 컬럼 표시
- Streamlit data_editor 호환성
- 컬럼 순서 정렬

**검증 방법:**
- 인플루언서별 탭에서 2차기간 컬럼이 정상적으로 표시되는지 확인
- Streamlit 에러가 발생하지 않는지 확인
- 2차활용 → 2차기간 → 전체_계약수 순서로 표시되는지 확인

**변경 완료 상태:** ✅ 완료

---

### 2024-12-19 2차기간 컬럼 위치 수정

**변경 내용:**
- `prepare_influencer_summary` 함수에서 `2차기간` 컬럼을 `2차활용` 바로 다음에 위치하도록 수정
- 컬럼 순서를 `2차활용` → `2차기간` → `전체_계약수` → `전체_집행수` → `전체_잔여수` 순서로 변경
- `cols.insert`에서 `2차기간`을 `2차활용` 바로 다음에 삽입하도록 수정

**변경 이유:**
- 사용자 요청: "2차활용 옆에 2차기간"
- 현재 `2차기간` 컬럼이 `전체_계약수`, `전체_집행수`, `전체_잔여수` 컬럼들 사이에 위치하여 가독성이 떨어짐

**영향받는 기능:**
- 인플루언서별 탭의 컬럼 순서
- 2차기간 컬럼 위치

**검증 방법:**
- 인플루언서별 탭에서 2차활용 → 2차기간 → 전체_계약수 순서로 표시되는지 확인

**변경 완료 상태:** ✅ 완료

---

### 2024-12-19 2차기간 컬럼 중복 오류 재해결

**변경 내용:**
- `prepare_influencer_summary` 함수에서 `2차기간` 컬럼 중복 추가 문제 재해결
- `cols.insert`에서 `2차기간` 중복 삽입 제거
- 컬럼 순서를 `2차활용` → `2차기간` → `전체_계약수` → `전체_집행수` → `전체_잔여수` 순서로 유지

**변경 이유:**
- Streamlit 에러 재발생: "All column names are required to be unique for usage with data editor. The following column names are duplicated: ['2차기간']"
- 이전 수정에서 중복 추가가 다시 발생함

**영향받는 기능:**
- 인플루언서별 탭의 2차기간 컬럼 표시
- Streamlit data_editor 호환성

**검증 방법:**
- 인플루언서별 탭에서 2차기간 컬럼이 정상적으로 표시되는지 확인
- Streamlit 에러가 발생하지 않는지 확인

**변경 완료 상태:** ✅ 완료

---

### 2024-12-19 숫자 컬럼 오른쪽 정렬 구현

**변경 내용:**
- `render_data_editor` 함수에서 `브랜드_계약수`를 `TextColumn`에서 `NumberColumn`으로 변경
- 모든 `NumberColumn`에 `format="%d"` 옵션 추가로 오른쪽 정렬 구현
- `process_numeric_columns` 함수에서 숫자 컬럼을 문자열로 변환하지 않고 정수형으로 유지

**변경 이유:**
- 사용자 요청: "정렬도 여전히 안되어있어 전에 말한대로 CSS 가 아닌 방법으로 오른쪽 정렬"
- 숫자 컬럼들이 왼쪽 정렬되어 있어 가독성이 떨어짐

**영향받는 기능:**
- 배정 및 집행결과 탭의 숫자 컬럼 정렬
- 인플루언서별 탭의 숫자 컬럼 정렬
- 모든 숫자 데이터의 표시 방식

**검증 방법:**
- 모든 숫자 컬럼(FLW, 1회계약단가, 브랜드_계약수, 브랜드_잔여수 등)이 오른쪽 정렬되는지 확인
- 숫자 데이터가 정수형으로 올바르게 표시되는지 확인

**변경 완료 상태:** ✅ 완료

---

### 2024-12-19 배정 및 집행결과 탭에 2차기간 컬럼 추가

**변경 내용:**
- `prepare_assignment_data` 함수에 `2차기간` 컬럼 추가 로직 구현
- `render_data_editor` 함수의 `column_config`에 `2차기간` 컬럼 설정 추가
- 엑셀 다운로드 컬럼 목록에 `2차기간` 추가
- 컬럼 순서를 `2차활용` → `2차기간` → `브랜드_계약수` 순서로 변경

**변경 이유:**
- 사용자 요청: "2차 기간 빠져있어 ,, 이외에도 빠진 부분 점검해줘"
- "배정 및 집행결과" 탭에서 `2차기간` 컬럼이 누락되어 있음

**영향받는 기능:**
- 배정 및 집행결과 탭의 컬럼 표시
- 엑셀 다운로드 기능
- 데이터 에디터 컬럼 설정

**검증 방법:**
- 배정 및 집행결과 탭에서 2차활용 → 2차기간 → 브랜드_계약수 순서로 표시되는지 확인
- 엑셀 다운로드 시 2차기간 컬럼이 포함되는지 확인

**변경 완료 상태:** ✅ 완료

---

### 2024-12-19 전체_집행수, 전체_잔여수 컬럼 표시 수정

**변경 내용:**
- `prepare_influencer_summary` 함수의 컬럼 순서 재정렬 로직에서 `전체_집행수`, `전체_잔여수` 컬럼도 포함하도록 수정
- 컬럼 순서를 `2차활용` → `2차기간` → `전체_계약수` → `전체_집행수` → `전체_잔여수` 순서로 변경

**변경 이유:**
- 사용자 요청: "전체_집행수, 전체_잔여수 컬럼 추가도 안되었잖아 다시 확인해줘"
- `add_brand_details`에서 컬럼을 추가했지만 `prepare_influencer_summary`에서 컬럼 순서 재정렬 시 누락됨

**영향받는 기능:**
- 인플루언서별 탭의 전체 필터 표시
- 전체_집행수, 전체_잔여수 컬럼 표시

**검증 방법:**
- 인플루언서별 탭에서 브랜드 필터 "전체" 선택 시 전체_집행수, 전체_잔여수 컬럼이 전체_계약수 옆에 표시되는지 확인

**변경 완료 상태:** ✅ 완료

---

### 2024-12-19 2차기간 컬럼 순서 수정

**변경 내용:**
- `prepare_influencer_summary` 함수에서 컬럼 순서를 `2차활용` → `2차기간` → `전체_계약수` 순서로 변경
- `cols.insert`에서 2차기간을 2차활용 바로 다음에 삽입하도록 수정

**변경 이유:**
- 사용자 요청: "2차기간 컬럼이 2차활용 바로 옆에 와야 하는데 아직 반영이 안되었어"

**영향받는 기능:**
- 인플루언서별 탭의 컬럼 순서
- 2차기간 컬럼 위치

**검증 방법:**
- 인플루언서별 탭에서 2차활용 → 2차기간 → 전체_계약수 순서로 표시되는지 확인

**변경 완료 상태:** ✅ 완료

---

### 2024-12-19 최종 복구 작업

**변경 내용:**
- `add_brand_details` 함수에 전체 필터 시 `전체_집행수`, `전체_잔여수` 계산 로직 추가
- `get_influencer_column_config`에 `전체_집행수`, `전체_잔여수` 컬럼 설정 추가

**변경 이유:** 
- 사용자가 요청한 "전체 필터에서 전체_집행수, 전체_잔여수 표시" 기능이 누락되어 복구

**영향받는 기능:**
- 인플루언서별 탭의 전체 필터 표시
- 전체 계약수, 집행수, 잔여수 계산 로직

**검증 방법:**
- 인플루언서별 탭에서 브랜드 필터 "전체" 선택 시 전체_집행수, 전체_잔여수 컬럼 확인

**변경 완료 상태:** ✅ 완료

---

### 2024-12-19 컬럼 순서 수정

**변경 내용:**
- "배정 및 집행결과" 탭에서 `결과` 컬럼이 `집행URL` 앞에 위치하도록 수정

**변경 이유:**
- 사용자 요청: "결과와 집행URL 컬럼 순서 변경"

**영향받는 기능:**
- 배정 및 집행결과 탭의 컬럼 순서

**검증 방법:**
- 배정 및 집행결과 탭에서 결과 컬럼이 집행URL 앞에 표시되는지 확인

**변경 완료 상태:** ✅ 완료

---

### 2024-12-19 중복 컬럼 오류 해결

**변경 내용:**
- `prepare_influencer_summary` 함수에서 `2차기간` 컬럼 중복 추가 문제 해결
- `cols.insert`에서 중복 추가 제거

**변경 이유:**
- Streamlit 에러: "All column names are required to be unique for usage with data editor. The following column names are duplicated: ['2차기간']"

**영향받는 기능:**
- 인플루언서별 탭의 2차기간 컬럼 표시
- Streamlit data_editor 호환성

**검증 방법:**
- 인플루언서별 탭에서 2차기간 컬럼이 정상적으로 표시되는지 확인
- Streamlit 에러가 발생하지 않는지 확인

**변경 완료 상태:** ✅ 완료

---

### 2024-12-19 테이블 CSS 제거

**변경 내용:**
- `load_css()` 함수에서 숫자 정렬 관련 CSS 완전 제거

**변경 이유:**
- 사용자 요청: "streamlit테이블에서는 CSS 적용이 잘 안되니 테이블에서는 항상 CSS 를 배제해줘"

**영향받는 기능:**
- 모든 테이블의 숫자 정렬
- 테이블 스타일링

**검증 방법:**
- 모든 테이블에서 CSS 관련 오류가 발생하지 않는지 확인

**변경 완료 상태:** ✅ 완료

---

## 📊 현재 구현된 주요 기능들

### ✅ 정상 작동하는 기능들:
1. **2차기간 컬럼**: 인플루언서별 탭에서 2차활용 옆에 2차기간 컬럼 정상 표시
2. **컬럼 순서**: 배정 및 집행결과 탭에서 결과 컬럼이 집행URL 앞에 위치
3. **ID/id 통일**: 모든 곳에서 id로 통일되어 KeyError 해결
4. **엑셀 업로드 필수 컬럼**: 브랜드, id, 배정월, 결과만 필수, 집행URL은 선택사항
5. **브랜드 필터별 컬럼 표시**: 특정 브랜드 선택 시 MLB_계약수, MLB_집행수, MLB_잔여수 등 표시
6. **전체_집행수, 전체_잔여수**: 인플루언서별 탭에서 브랜드 필터가 "전체"일 때 전체_계약수 옆에 전체_집행수, 전체_잔여수 컬럼 추가
7. **테이블 CSS 제거**: 숫자 정렬 관련 CSS 완전 제거로 Streamlit 호환성 확보

---

## 🔧 향후 변경사항 관리

### 변경 요청 시:
1. 변경 전 현재 상태 기록
2. 변경 내용 상세 기술
3. 변경 후 예상 결과 명시
4. 검증 방법 제시

### 변경 완료 후:
1. 실제 변경 결과 확인
2. 기존 기능 영향도 검증
3. 이 문서 업데이트

---

## 📝 참고사항

- 모든 변경사항은 이 문서에 기록
- 변경 완료 후 반드시 검증 수행
- 기존 기능에 영향이 없는지 확인
- 사용자 요청사항과 정확히 일치하는지 검증

---

## 🛡️ 코드 안전성 수칙

### 컬럼 추가/변경 시 필수 체크:
1. **중복 확인**: 컬럼이 이미 존재하는지 먼저 확인
2. **제거 후 삽입**: `cols.remove()` 로 기존 제거 후 새 위치에 삽입
3. **rename + insert 금지**: 동시 사용 시 중복 발생 위험
4. **위치 확인**: 삽입 위치가 올바른지 검증

### 안전한 컬럼 처리 패턴:
```python
# 안전한 컬럼 추가 방법
if "컬럼명" in cols:
    cols.remove("컬럼명")
cols.insert(위치, "컬럼명")
```

### 수정 전 체크리스트:
- [ ] 기존 컬럼 중복 여부 확인
- [ ] 컬럼 순서 변경 시 기존 위치 제거
- [ ] Streamlit data_editor 호환성 검증
- [ ] 변경사항 문서화

---

### 2025-08-27 전체 선택 버튼 기능 최종 해결

**변경 내용:**
- `render_data_editor` 함수에서 `CheckboxColumn`에 `default` 옵션 추가
- `render_table_controls` 함수에서 전체 선택 버튼 클릭 시 데이터 에디터 키를 동적으로 변경
- `render_data_editor` 함수에서 동적 키를 사용하여 강제 새로고침 구현
- 전체 선택 상태와 동적 키 변경을 조합하여 체크박스 상태 제어

**변경 이유:**
- 사용자 요청: "아직도해결이안되엇어"
- `CheckboxColumn`의 `default` 옵션만으로는 기존 데이터의 체크박스 상태를 변경할 수 없어 동적 키 변경 방식 추가

**영향받는 기능:**
- 배정 및 집행결과 탭의 전체 선택/해제 기능
- 체크박스 상태 동기화

**검증 방법:**
- 전체 선택 버튼 클릭 시 모든 체크박스가 선택되는지 확인
- 전체 해제 버튼 클릭 시 모든 체크박스가 해제되는지 확인
- 개별 체크박스 선택/해제가 정상 작동하는지 확인

**변경 완료 상태:** ✅ 완료

---

### 2025-08-27 수동 배정 알림 간소화

**변경 내용:**
- `execute_manual_assignment` 함수에서 수동 배정 성공 알림 제거
- 수동 배정 완료 시 불필요한 대기 시간 제거
- 중복 배정 알림을 간결하게 수정
- 수동 배정 작업 완료 후 조용히 페이지 새로고침만 실행

**변경 이유:**
- 사용자 요청: "수동배정 추가할 떄의 알림문도 적절하지않아"
- 불필요한 성공 알림과 대기 시간으로 인한 사용자 경험 저하 해결
- 자동 배정과 동일하게 조용한 처리 방식으로 통일

**영향받는 기능:**
- 수동 배정 성공 시 알림
- 중복 배정 확인 메시지
- 수동 배정 완료 후 자동 새로고침

**검증 방법:**
- 수동 배정 실행 시 성공 알림이 표시되지 않는지 확인
- 중복 배정 시 간결한 알림이 표시되는지 확인
- 수동 배정 완료 후 페이지가 정상적으로 새로고침되는지 확인

**변경 완료 상태:** ✅ 완료

---

### 2025-08-27 전체 선택 체크박스 기능 원래 방식으로 복구

**변경 내용:**
- 백업 파일(fnfcrew_backup_20250827_final.py)의 작동했던 방식을 기반으로 복구
- **함수 호출 순서 변경**: `prepare_assignment_data` → `render_table_controls` → `render_data_editor`
- **동적 키 제거**: `key="assignment_data_editor"` (고정 키로 변경)
- **`default_checked` 변수 사용**: `render_data_editor` 함수 내에서 정의하여 `CheckboxColumn`에 전달
- **불필요한 동적 키 로직 제거**: `data_editor_key` 관련 코드 제거

**변경 이유:**
- 사용자 요청: "default 옵션이 문제인지 확실치 않잖아? 내가 얘기한건 changelog 기록하기 더 이전에 문제없이 작동했을 때의 기록이야"
- 백업 파일 확인 결과, 이전에 작동했던 방식과 현재 방식이 다름을 발견
- 복잡한 동적 키 방식 대신 단순하고 안정적인 원래 방식으로 복구

**영향받는 기능:**
- 배정 및 집행결과 탭의 전체 선택/해제 기능
- 체크박스 상태 동기화

**검증 방법:**
- 전체 선택 버튼 클릭 시 모든 체크박스가 선택되는지 확인
- 전체 해제 버튼 클릭 시 모든 체크박스가 해제되는지 확인
- 개별 체크박스 선택/해제가 정상 작동하는지 확인

**변경 완료 상태:** ✅ 완료
